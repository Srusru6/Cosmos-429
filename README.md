# Cosmos 429 - Ecosystem Simulation

这是一个基于 Python 的二维细胞自动机生态系统模拟程序。模拟了一个包含光照、土壤肥力以及多种生物单元的复杂环境。生物通过 DNA 遗传特性，并在环境中进行能量交换、繁殖、变异、竞争和进化。

## 📋 环境要求

- Python 3.x
- Matplotlib
- Numpy

安装依赖:
```bash
pip install matplotlib numpy
```

## 🚀 运行方法

直接运行主程序:
```bash
python ecosystem_simulation.py
```

**控制说明**:
*   **空格键 (Space)**: 暂停 / 继续模拟
*   **Q 或 Esc**: 结束模拟并保存优势物种 DNA

## 🧬 模拟机制

### 1. 环境 (Environment)
*   **光照 (Light)**: 初始从地图中心向四周递减。
    *   **遮挡机制**: 光合生物出生时会永久性降低周围光照（模拟树荫），死亡时恢复。
*   **肥力 (Fertility)**: 初始分布与光照类似。
    *   **消耗与循环**: 生物出生会消耗周围肥力，死亡后归还肥力。
    *   **自然恢复**: 肥力会随时间缓慢自然恢复至基准水平。
    *   **工厂改善**: 工厂单元可以消耗能量主动改善周围土壤肥力。
    *   **致死**: 肥力过低会导致生物死亡。

### 2. 生物单元 (Units)
*   **🟢 光合单元 (PhotosynthesisUnit)**
    *   利用光照产生能量。
    *   将能量平均分享给周围的生物。
    *   **防御机制**: 遇到异种战斗单元时，会触发"一换一"自爆，无视能量差异消灭敌人。
    *   副作用：显著降低周围光照。
*   **🔴 复制单元 (ReplicationUnit)**
    *   负责繁衍后代。
    *   积累能量达到阈值后，在周围生成新的复制单元。
    *   **分化**: 可根据 DNA 和环境条件（光照/肥力）分化为光合单元、连接单元或工厂单元。
    *   **退化**: 如果连续一回合无法找到空位繁殖，会自动退化为连接单元。
    *   **警戒**: 发现异种生物时，变身为战斗单元。
*   **🔵 连接单元 (ConnectionUnit)**
    *   作为能量传输的介质。
    *   从高能量单元接收能量并传递给其他邻居（有损耗）。
    *   肥力过低时会牺牲自己以保全环境。
*   **🟣 工厂单元 (FactoryUnit)**
    *   **环境改造者**: 消耗能量（1.0/step）缓慢增加周围 3 格范围内的肥力（+0.001/step）。
    *   通常在肥力较低的区域由复制单元分化而来。
*   **🟠 战斗单元 (CombatUnit)**
    *   **竞争者**: 专门用于攻击异种生物。
    *   **同化**: 若能量高于敌人，消耗对方一半能量将其同化为己方复制单元。
    *   若周围无敌人，自动变回复制单元。
*   **⚪ 孢子单元 (SporeUnit)**
    *   用于远距离传播和突变。
    *   生成后下一刻会"爆发"，在中心生成光合单元，四周生成复制单元。

### 3. DNA 与 进化
每个生物携带一组 DNA 参数，决定其行为模式，并在繁殖/传粉时发生变异：
*   `species_id`: 种群 ID，用于区分敌我。
*   `light_threshold`: 决定分化策略的光照阈值。
*   `fertility_threshold`: 决定分化策略的肥力阈值。
*   `replication_threshold`: 繁殖所需的能量积累量。
*   `mutation_prob`: 发生突变的概率。
*   `factory_prob`: 变身为工厂单元的概率。
*   `factory_fertility_threshold`: 触发工厂变身的肥力阈值。

### 4. 全局机制
*   **随机传粉 (Pollination)**: 每 10 个模拟步，系统会随机选取一个现有生物的 DNA（并进行轻微变异），在地图随机空位生成一个孢子。
*   **物种存档**: 模拟结束时，系统会自动保存数量最多的前 10 个物种的 DNA 到 `top_species.json`。下次运行时会自动读取，作为初始物种投放。
*   **能量代谢**: 所有生物每回合消耗基础代谢能量，能量耗尽则死亡。

## 📊 可视化说明

程序运行时会显示 2x3 的动态窗口：

1.  **Organism Types (左上)**: 生物种类分布（绿=光合，红=复制，蓝=连接，紫=工厂，橙=战斗，黑=空）。
2.  **DNA Visualization (右上)**: 生物 DNA 特征的可视化 (RGB 映射)。
3.  **Energy Levels (上中)**: 生物能量水平（黄色越亮能量越高）。
4.  **Light Distribution (左下)**: 实时光照地图（灰度）。
5.  **Fertility (下中)**: 实时肥力地图（绿色代表肥沃，红色代表贫瘠）。
